<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft-Server-Daten</title>
    <link rel="stylesheet" href="/site/font-faces.css">
    <link rel="icon" href="/favicon.ico" type="image/vnd.microsoft.icon">
    <style>
        html {
            font-family: Figtree, sans-serif;
            padding: 2.5rem;
            background-color: #1c1c1c;
        }

        h1 {
            color: #00ffcc;
            font-size: 3rem;
        }

        h3 {
            color: #00ffcc;
            font-size: 1.8rem;
            margin-top: 2rem;
        }

        .mono {
            font-family: Mono, monospace;
            color: whitesmoke;
        }

        .mono > p {
            background-color: #101010;
            border-radius: 0.3rem;
            padding: 0.3rem 0.5rem;
            font-size: 1rem;
        }

        #zeit {
            margin-top: 2rem;
            color: #aaa;
            font-size: 0.9rem;
        }

        .error {
            color: #ff5555;
        }
    </style>
</head>
<body>
    <h1>Minecraft-Server-Daten</h1>
    <div class="mono" id="server"><p style="font-size: 2rem;">mc.chiro07.at (chiro.exaroton.me)</p></div>

    <h3>MOTD:</h3>
    <div class="mono" id="motd"><p>...</p></div>

    <hr>

    <h3>Status:</h3>
    <div class="mono" id="status"><p>Wird geladen...</p></div>

    <h3>Version:</h3>
    <div class="mono" id="version"><p>...</p></div>

    <h3>Spieler:</h3>
    <div class="mono" id="spieler"><p>...</p></div>

    <div id="zeit">Zuletzt aktualisiert um: --:--:--</div>

    <script>
        // === Konfiguration ===
        const SERVER_ID = "EINWOhDy9hlZc31U";
        const PROXY_URL = "https://exaroton-proxy.onrender.com";
        const UPDATE_INTERVAL = 10000; 

        function parseMotd(motd) {
            if (!motd) return "";
            const colorMap = {
                "0": "#000000", "1": "#0000AA", "2": "#00AA00", "3": "#00AAAA",
                "4": "#AA0000", "5": "#AA00AA", "6": "#FFAA00", "7": "#AAAAAA",
                "8": "#555555", "9": "#5555FF", "a": "#55FF55", "b": "#55FFFF",
                "c": "#FF5555", "d": "#FF55FF", "e": "#FFFF55", "f": "#FFFFFF"
            };

            let result = "";
            let openTags = [];
            motd = motd.replace(/\\n/g, "\n"); // escaped newline fix

            for (let i = 0; i < motd.length; i++) {
                if (motd[i] === "§" && i + 1 < motd.length) {
                    const code = motd[++i].toLowerCase();

                    if (colorMap[code]) {
                        // Farbe ändern → vorherige schließen
                        result += "</span>";
                        result += `<span style="color:${colorMap[code]}">`;
                        continue;
                    }

                    switch (code) {
                        case "l": result += "<b>"; openTags.push("</b>"); break;
                        case "n": result += "<u>"; openTags.push("</u>"); break;
                        case "o": result += "<i>"; openTags.push("</i>"); break;
                        case "m": result += "<s>"; openTags.push("</s>"); break;
                        case "k": result = "#"; openTags.push(""); break; // '#' statt obfuscated
                        case "r":
                            // Reset: alle offenen Tags schließen
                            while (openTags.length) result += openTags.pop();
                            result += "</span><span style='color:#FFFFFF'>";
                            break;
                    }
                } else if (motd[i] === "\n") {
                    result += "<br>";
                } else {
                    result += motd[i];
                }
            }

            // offene Tags schließen
            while (openTags.length) result += openTags.pop();
            return `<span style="color:#FFFFFF">${result}</span>`;
        }

        async function ladeServerDaten() {
            try {
                const serverRes = await fetch(`${PROXY_URL}/api/server/${SERVER_ID}`);
                if (!serverRes.ok) throw new Error(`Serverdaten HTTP ${serverRes.status}`);
                const serverResult = await serverRes.json();
                const server = serverResult.data;
                if (!server) throw new Error("Keine Serverdaten empfangen");

                // === Anzeige aktualisieren ===
                const statusNamen = [
                    "Offline", "Online", "Starting", "Stopping",
                    "Restarting", "Saving", "Loading", "Crashed", "Preparing"
                ];
                const statusText = statusNamen[server.status] || "Unbekannt";
                document.querySelector("#status p").textContent = statusText;

                // Version
                const ver = server.software.version
                const vertype = server.software.name ?? "Unbekannt";
                document.querySelector("#version p").textContent =
                    `${vertype} ${ver}`;

                // MOTD
                const motd = server.motd || "(keine MOTD gesetzt)";
                document.querySelector("#motd p").innerHTML = parseMotd(motd);

                // Spieler
                const players = server.players?.list ?? [];
                document.querySelector("#spieler p").innerHTML =
                    players.length > 0 ? players.join("<br>") : "Keine Spieler online";

                // Zeit
                const jetzt = new Date();
                const hh = String(jetzt.getHours()).padStart(2, "0");
                const mm = String(jetzt.getMinutes()).padStart(2, "0");
                const ss = String(jetzt.getSeconds()).padStart(2, "0");
                document.querySelector("#zeit").textContent =
                    `Zuletzt aktualisiert um: ${hh}:${mm}:${ss}`;
            } catch (err) {
                console.error("Fehler:", err);
                document.querySelector("#status p").textContent = "Fehler beim Laden";
                document.querySelector("#status p").classList.add("error");
            }
        }

        // Beim Laden sofort abrufen
        ladeServerDaten();

        // Regelmäßig aktualisieren
        setInterval(ladeServerDaten, UPDATE_INTERVAL);
    </script>
</body>
</html>
